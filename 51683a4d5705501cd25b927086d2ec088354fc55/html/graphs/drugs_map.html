<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v3.min.js"></script>
<link rel="stylesheet" href="../stories/cece-styles.css">
<style type="text/css">
a {
    text-decoration: none;
    display: inline-block;
    padding: 8px 16px;
}

a:hover {
    background-color: #ddd;
    color: black;
}

.previous {
    background-color: #f1f1f1;
    color: black;
}

.next {
    background-color: #002147;
    color: white;
}

.round {
    border-radius: 15px;
}

.nextPreviousButtons {
  display: flex;
  justify-content: center;
  align-items: center;
}

.svg-container {
	display: flex;
  justify-content: center;
  align-items: center;
}

/* On mouse hover, lighten state color */
path:hover {
	fill-opacity: .7;
}

/* Style for Custom Tooltip */
div.tooltip {
 	position: absolute;
	text-align: center;
	padding: 2px;
	font: 12px sans-serif;
	background: white;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

/* Legend Font Style */
body {
	font: 12px sans-serif;
}

</style>
<title>Rhodes Transactions Map</title>
</head>

<body>
<h1>RhodesTransactions Map</h1>
<div id="container" class="svg-container"></div>
<script type="text/javascript">

//Width and height of map
var width = 1000;
var height = 550;

var numberParse = d3.format(",");
var formatDecimalComma = d3.format(",.2f");

// D3 Projection
var projection = d3.geo.albersUsa()
//albersUsaAll()					// all USA territory
				   .translate([width/2, height/2])    // translate to center of screen
				   .scale([1250]);          // scale things down so see entire US

// Define path generator
var path = d3.geo.path()               // path generator that will convert GeoJSON to SVG paths
		  	 .projection(projection);  // tell path generator to use albersUsa projection

//Create SVG element and append map to the SVG
var svg = d3.select("div#container")
			.append("svg")
			.attr("width", width)
			.attr("height", height);

// Append Div for tooltip to SVG
var div = d3.select("body")
		    .append("div")
    		.attr("class", "tooltip")
    		.style("opacity", 0);

// Load in my states data!
d3.csv("data/states_coordinates.csv", function(data) {

	// Load GeoJSON data and merge with states data
	d3.json("us-states.json", function(json) {

	// Loop through each state data value in the .csv file
	for (var i = 0; i < data.length; i++) {

		// Grab State Name
		var dataState = data[i].BUYER_STATE;

		// Grab quantity
		var dataQuantity = data[i].QUANTITY;

		// Grab MME
		var dataMME = data[i].MME;

		// Grab population
		var dataPop = data[i].population;

		// Find the corresponding state inside the GeoJSON
		for (var j = 0; j < json.features.length; j++)  {
			var jsonState = json.features[j].properties.name;

			if (dataState == jsonState) {

				// Copy the data values into the JSON
				json.features[j].properties.quantity = dataQuantity;
				json.features[j].properties.mme = dataMME;
				json.features[j].properties.pop = dataPop;

				// Stop looking through the JSON
				break;
			}
		}
	}

	// Bind the data to the SVG and create one path per GeoJSON feature
	svg.selectAll("path")
		.data(json.features)
		.enter()
		.append("path")
		.attr("d", path)
		.style("stroke", "#fff")
		.style("stroke-width", "1")
		.style("fill","rgb(213,222,217)")
		.on("mouseover", function(d) {
	    	div.transition()
	      	   .duration(200)
	           .style("opacity", .9);
	           div.html(d.properties.name + "<br/>"+
						 					"Quantity: " + numberParse(d.properties.quantity) + "<br/>"+
											"MME: " +  formatDecimalComma(d.properties.mme))
						 .style("left", (d3.event.pageX) + "px")
	           .style("top", (d3.event.pageY - 28) + "px");

		})

	    // fade out tooltip on mouse out
	    .on("mouseout", function(d) {
	        div.transition()
	           .duration(500)
	           .style("opacity", 0);
	    });

	// Map the proportion of quantity in each state

	var circleSize = d3.scale.linear().range([0,5500]).domain([0, 137175]);

	svg.selectAll("circle")
		.data(data)
		.enter()
		.append("circle")
		.attr("cx", function(d) {
			return projection([d.lon, d.lat])[0];
		})
		.attr("cy", function(d) {
			return projection([d.lon, d.lat])[1];
		})
		.attr("r", function(d) {
			console.log(circleSize(Math.sqrt(d.MME / (Math.PI * 500))))
			console.log(d.MME / d.population)
			//return circleSize(Math.sqrt(d.MME / (Math.PI * 500)));
			return circleSize(Math.sqrt(d.MME / d.population))*35;
		})
			.style("fill", "rgb(217,91,67)")
			.style("opacity", 0.85)

		// Modification of custom tooltip code provided by Malcolm Maclean, "D3 Tips and Tricks"
		// http://www.d3noob.org/2013/01/adding-tooltips-to-d3js-graph.html
		.on("mouseover", function(d) {
	    	div.transition()
	      	   .duration(200)
	           .style("opacity", .9);
	           div.html(d.BUYER_STATE + "<br/>"+
						 					"Quantity: " + numberParse(d.QUANTITY) + "<br/>"+
											"MME: " +  formatDecimalComma(d.MME) + "<br/>" +
											"Population: " + numberParse(d.population))
	           .style("left", (d3.event.pageX) + "px")
	           .style("top", (d3.event.pageY - 28) + "px");
		})

	  // fade out tooltip on mouse out
	  .on("mouseout", function(d) {
	      div.transition()
	         .duration(500)
	         .style("opacity", 0);
	  });

		// add title of graphic
		// svg.append("text")
	  //       .attr("x", (width / 2))
	  //       .attr("y", 35)
	  //       .attr("text-anchor", "middle")
	  //       .style("font-size", "28px")
	  //       .style("text-decoration", "underline")
	  //       .text("Rhodes Drug Flow");

	});
});
</script>
<br><br>
<div class="nextPreviousButtons">
  <a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/graphs/rhodes_drug_types_donut.html" class="previous round">&laquo; Previous</a>
  <a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/dollars4docs.html" class="next round">Dollars for Docs&raquo;</a>
</div>
</body>
</html>
