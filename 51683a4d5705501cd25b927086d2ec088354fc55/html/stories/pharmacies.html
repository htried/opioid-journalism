<!DOCTYPE html>
<html>
<meta charset="utf-8">
<head>
<script type="text/javascript" src="https://d3js.org/d3.v5.min.js"></script>
<link rel="stylesheet" href="styles.css">
</head>
<h1>
	ARCOS/Pharmacies
</h1>
<body>
<p>
We obtained data from the DEA Opioid Prescription Dataset (ARCOS), which tracks the path of every single pain pill sold in the US from 2006-2014. After extensive cleaning, we've managed to create the following visualizations. We whittled the data down to transactions in which the BUYER_CITY (city in which the buyer was located) were all Rhode Island towns.
</p>
<h2>
	Emergency Department Visits, Overdose Deaths, and Naloxone Use
</h2>
<p>
<div id="container" class="svg-container"></div>
<script>
//------------------------1. PREPARATION------------------------//
//-----------------------------SVG------------------------------//
const width = 960;
const height = 420;
const margin = 5;
const padding = 5;
const adj = 70;
// we are appending SVG first
const svg = d3.select("div#container").append("svg")
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "-"
          + adj + " -"
          + adj + " "
          + (width + adj *3) + " "
          + (height + adj*3))
    .style("padding", padding)
    .style("margin", margin)
    .classed("svg-content", true);

//-----------------------------DATA-----------------------------//
const dataset = d3.csv("../graphs/data/ridoh.csv");
dataset.then(function(data) {
    var slices = data.columns.slice(1).map(function(id) {
        return {
            id: id,
            values: data.map(function(d){
                return {
                    municipality: d.Municipality,
                    measurement: +d[id]
                };
            })
        };
    });

//----------------------------SCALES----------------------------//
const xScale = d3.scaleBand()
    .domain(data.map(function (d) { return d.Municipality; }))
    .rangeRound([0, width])
    .padding(1);
const yScale = d3.scaleLinear().rangeRound([height, 0]);
yScale.domain([(0), d3.max(slices, function(c) {
    return d3.max(c.values, function(d) {
        return d.measurement + 4; });
        })
    ]);

//-----------------------------AXES-----------------------------//
const yaxis = d3.axisLeft()
    .ticks((slices[0].values).length)
    .scale(yScale);

const xaxis = d3.axisBottom(xScale);

//----------------------------LINES-----------------------------//
const line1 = d3.line()
    .x(function(d) { return xScale(d.municipality); })
    .y(function(d) { return yScale(d.measurement); });

let id = 0;
const ids = function () {
    return "line-"+id++;
}

//---------------------------TOOLTIP----------------------------//
const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0)
    .style("position", "absolute");

//-------------------------2. DRAWING---------------------------//
//-----------------------------AXES-----------------------------//
svg.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xaxis)
    .selectAll("text")
    .attr("transform", "rotate(-80)")
    .style("text-anchor", "end")
    .attr("x", -9)
    .attr("y", 1);

svg.append("g")
    .attr("class", "axis")
    .call(yaxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("dy", ".75em")
    .attr("y", 6)
    .style("text-anchor", "end")
    .text("Frequency");

//----------------------------LINES-----------------------------//
const lines1 = svg.selectAll("lines1")
    .data(slices)
    .enter()
    .append("g");

    lines1.append("path")
    .attr("class", ids)
    .attr("d", function(d) { return line1(d.values); });

    lines1.append("text")
    .attr("class","serie_label")
    .datum(function(d) {
        return {
            id: d.id,
            value: d.values[d.values.length - 1]}; })
    .attr("transform", function(d) {
            return "translate(" + (xScale(d.value.municipality) + 5)
            + "," + (yScale(d.value.measurement) + 5 ) + ")"; })
    .attr("x", 5)
    .text(function(d) { return d.id; });

//---------------------------POINTS-----------------------------//
    lines1.selectAll("points")
    .data(function(d) {return d.values})
    .enter()
    .append("circle")
    .attr("cx", function(d) { return xScale(d.municipality); })
    .attr("cy", function(d) { return yScale(d.measurement); })
    .attr("r", 1)
    .attr("class","point")
    .style("opacity", 1);

//---------------------------EVENTS-----------------------------//
    lines1.selectAll("circles")
    .data(function(d) { return(d.values); } )
    .enter()
    .append("circle")
    .attr("cx", function(d) { return xScale(d.municipality); })
    .attr("cy", function(d) { return yScale(d.measurement); })
    .attr('r', 10)
    .style("opacity", 0)
    .on('mouseover', function(d) {
        tooltip.transition()
    .delay(30)
        .duration(200)
        .style("opacity", 1);
        tooltip.html(d.measurement)
        .style("left", (d3.event.pageX + 25) + "px")
        .style("top", (d3.event.pageY) + "px");
        const selection = d3.select(this).raise();
        selection
        .transition()
        .delay("20")
        .duration("200")
        .attr("r", 6)
        .style("opacity", 1)
        .style("fill","#ed3700");
    })
    .on("mouseout", function(d) {
        tooltip.transition()
        .duration(100)
        .style("opacity", 0);
        const selection = d3.select(this);
        selection
        .transition()
        .delay("20")
        .duration("200")
        .attr("r", 10)
        .style("opacity", 0);
    });

});
</script>
</p>
<p>
	This graph depicts the number of emergency department visits, overdose deaths, and naloxone uses by town from the years 2016-2019. Some numbers in towns were recorded <5, and for the purposes of graphing, converted to 2.5.

	The graph shows that the highest numbers of ED visits, OD deaths, and naloxone use are recorded in Providence and the surrounding area, Pawtucket, Warwick, Woonsocket, and Cranston. The high density of cases are also reflected in West Warwick and East Providence.
</p>
<p>
<select id="selectButton"></select>
<div id="container2" class="svg-container2"></div>
<script>
//------------------------1. PREPARATION------------------------//
//-----------------------------SVG------------------------------//
// we are appending SVG first
const svg2 = d3.select("div#container2").append("svg")
    .attr("preserveAspectRatio", "xMinYMin meet")
    .attr("viewBox", "-"
          + adj + " -"
          + adj + " "
          + (width + adj *3) + " "
          + (height + adj*3))
    .style("padding", padding)
    .style("margin", margin)
    .classed("svg-content", true);

//-----------------------------DATA-----------------------------//
const dataset2 = d3.csv("../graphs/data/ridoh_by_year.csv");
dataset2.then(function(data) {
    slices = data.columns.slice(2).map(function(id) {
        return {
            id: id,
            values: data.map(function(d){
                return {
                    municipality: d.Municipality,
                    year: d.Year,
                    measurement: +d[id]
                };
            })
        };
    });

    // Deep copy slices object
    function deepCopy(selectedYear) {
        var filtered = [];
        for (var i = 0; i < slices.length; i++) {
            var val_copy = [];
            for (var j = 0; j < slices[0].values.length; j++) {
                if (slices[i].values[j].year == selectedYear) {
                    val_copy.push({
                        municipality: slices[i].values[j].municipality,
                        year: slices[i].values[j].year,
                        measurement: slices[i].values[j].measurement
                    });
                }
            }
            filtered.push({
                id: slices[i].id,
                values: val_copy
            });
        }
        return filtered;
    }
    const groups = d3.map(data, function(d) { return (d.Year); }).keys();
    // Initialize year to default 2016-2019
    var filtered_slice = deepCopy(groups[0]);

//----------------------------BUTTON----------------------------//
d3.select("#selectButton")
      .selectAll('myOptions')
        .data(groups)
      .enter()
        .append('option')
      .text(function (d) { return d; })
      .attr("value", function (d) { return d; })

//----------------------------SCALES----------------------------//
const xScale = d3.scaleBand()
    .domain(data.map(function (d) { return d.Municipality; }))
    .rangeRound([0, width])
    .padding(1);
const yScale = d3.scaleLinear().rangeRound([height, 0]);
yScale.domain([(0), d3.max(filtered_slice, function(c) {
    return d3.max(c.values, function(d) {
        return d.measurement + 4; });
        })
    ]);

//-----------------------------AXES-----------------------------//
const yaxis = d3.axisLeft()
    .ticks((filtered_slice[0].values).length)
    .scale(yScale);

const xaxis = d3.axisBottom(xScale);

//----------------------------LINES-----------------------------//
const line = d3.line()
    .x(function(d) { return xScale(d.municipality); })
    .y(function(d) { return yScale(d.measurement); });

let id = 0;
const ids = function () {
    return "line-"+id++;
}

//---------------------------TOOLTIP----------------------------//
const tooltip = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0)
    .style("position", "absolute");

//-------------------------2. DRAWING---------------------------//
//-----------------------------AXES-----------------------------//
svg2.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0," + height + ")")
    .call(xaxis)
    .selectAll("text")
    .attr("transform", "rotate(-80)")
    .style("text-anchor", "end")
    .attr("x", -9)
    .attr("y", 1);

svg2.append("g")
    .attr("class", "yaxis")
    .call(yaxis)
    .append("text")
    .attr("transform", "rotate(-90)")
    .attr("dy", "1em")
    .attr("x", 0 - (height / 2))
    .attr("y", 0 - margin)
    .style("text-anchor", "middle")
    .text("Frequency");

svg2.append("text")
    .attr("x", (width / 2))
    .attr("y", 0 - margin * 2)
    .attr("text-anchor", "middle")
    .style("font-size", "20px")
    .text("OD, ED, Naloxone Use and Distribution by Town");

//----------------------------LINES-----------------------------//
var lines = svg2.selectAll(".lines")
    .data(filtered_slice)
    .enter()
    .append("g");

    lines.append("path")
    .attr("class", "line")
    .attr("d", function(d) { return line(d.values); })
    .style("stroke", function(){
                return '#'+Math.floor(Math.random()*16777215).toString(16);
        });

    lines.append("text")
    .attr("class","serie_label")
    .datum(function(d) {
        return {
            id: d.id,
            value: d.values[d.values.length - 1]}; })
    .attr("transform", function(d) {
            return "translate(" + (xScale(d.value.municipality) + 5)
            + "," + (yScale(d.value.measurement) + 5 ) + ")"; })
    .attr("x", 5)
    .text(function(d) { return d.id; });

    // A function that updates the chart
    function update(selectedGroup) {
        // Create new data with the selection
        filtered_slice = deepCopy(selectedGroup);

        yScale.domain([(0), d3.max(filtered_slice, function(c) {
            return d3.max(c.values, function(d) {
                return d.measurement + 4; });
            })
        ]);

// // //-----------------------------UPDATE-----------------------------//

        svg2.selectAll(".yaxis").transition().duration(1500).call(yaxis);

        // generate line paths
        var lines = svg2.selectAll(".line").data(filtered_slice);

        // transition from previous paths to new paths
        lines.transition().duration(1500)
            .attr("d",function(d) {return line(d.values);})
            .style("stroke", function(){
                return '#'+Math.floor(Math.random()*16777215).toString(16);
        });

        // Reposition labels
        var serie_label = svg.selectAll(".serie_label")
            .data(filtered_slice)
            .attr("class", "serie_label");

        serie_label.transition().duration(1500)
            .attr("transform", function(d) {
                console.log(d);
                var mx = d.values[d.values.length - 1];
                return "translate(" + (xScale(mx.municipality) + 5)
                    + "," + (yScale(mx.measurement) + 5 ) + ")"; });
        // exit
        lines.exit().remove();
    }
    // When the button is changed, run the updateChart function
    d3.select("#selectButton").on("change", function(d) {
        // recover the option that has been chosen
        var selectedOption = d3.select(this).property("value")
        // run the updateChart function with this selected option
        update(selectedOption)
    })

    // // //-----------------------------HOVER-----------------------------//

    var mouseG = svg2.append("g")
      .attr("class", "mouse-over-effects");

    mouseG.append("path") // this is the black vertical line to follow mouse
      .attr("class", "mouse-line")
      .style("stroke", "black")
      .style("stroke-width", "1px")
      .style("opacity", "0");

    var lines = document.getElementsByClassName('line');

    var mousePerLine = mouseG.selectAll('.mouse-per-line')
      .data(filtered_slice)
      .enter()
      .append("g")
      .attr("class", "mouse-per-line");

    mousePerLine.append("circle")
      .attr("r", 7)
      // .style("stroke", function(d) {
      //   return color(d.id);
      // })
      .style("fill", "none")
      .style("stroke-width", "1px")
      .style("opacity", "0");

    mousePerLine.append("text")
      .attr("transform", "translate(10,3)");

    mouseG.append('svg:rect') // append a rect to catch mouse movements on canvas
      .attr('width', width) // can't catch mouse events on a g element
      .attr('height', height)
      .attr('fill', 'none')
      .attr('pointer-events', 'all')
      .on('mouseout', function() { // on mouse out hide line, circles and text
        d3.select(".mouse-line")
          .style("opacity", "0");
        d3.selectAll(".mouse-per-line circle")
          .style("opacity", "0");
        d3.selectAll(".mouse-per-line text")
          .style("opacity", "0");
      })
      .on('mouseover', function() { // on mouse in show line, circles and text
        d3.select(".mouse-line")
          .style("opacity", "1");
        d3.selectAll(".mouse-per-line circle")
          .style("opacity", "1");
        d3.selectAll(".mouse-per-line text")
          .style("opacity", "1");
      })
      .on('mousemove', function() { // mouse moving over canvas
        var mouse = d3.mouse(this);
        d3.select(".mouse-line")
          .attr("d", function() {
            var d = "M" + mouse[0] + "," + height;
            d += " " + mouse[0] + "," + 0;
            return d;
          });

        d3.selectAll(".mouse-per-line")
          .attr("transform", function(d, i) {
            var xDate = xScale(mouse[0]),
                bisect = d3.bisector(function(d) { return d.measurement; }).right;
                idx = bisect(d.values, xDate);

            var beginning = 0,
                end = lines[i].getTotalLength(),
                target = null;

            while (true){
              target = Math.floor((beginning + end) / 2);
              pos = lines[i].getPointAtLength(target);
              if ((target === end || target === beginning) && pos.x !== mouse[0]) {
                  break;
              }
              if (pos.x > mouse[0])      end = target;
              else if (pos.x < mouse[0]) beginning = target;
              else break; //position found
            }

            d3.select(this).select('text')
              .text(yScale.invert(pos.y).toFixed(2));

            return "translate(" + mouse[0] + "," + pos.y +")";
          });
      });

});
</script>
</p>
<p>
	The recorded peaks in Providence and the surrounding areas stay relatively stable over the years. Other towns, like Lincoln, West Warick, and Westerly experience a lot of fluctuation.
</p>
<p>
    <img src="../imgs/pharmacies1.png" alt="Providence pharmacies" width="800">
</p>
<p>
    <img src="../imgs/pharmacies2.png" alt="Providence pharmacies tooltip" width="800">
</p>
<p>
    <img src="../imgs/oded.png" alt="ODs and EDs by town" width="800">
</p>
<p>
    <img src="../imgs/naloxone.png" alt="Naloxone use and distribution" width="800">
</p>
<ul>
<link rel="stylesheet" type="text/css" href="../graphs/styles.css">
  <ul>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/dollars4docs.html">Dollars for Docs</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/iwp.html">Injured Workers Pharmacy</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/ods.html">Overdoses in Providence</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/rhodes.html">Rhodes</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/courtdata.html">Court Data</a></li>
  </ul>
</body>
</html>
