<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="cece-styles.css">
  <meta charset ="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
  /* body {
  	margin: auto;
  	width: 650px;
  	font: 12px arial;
  } */
  a {
      text-decoration: none;
      display: inline-block;
      padding: 8px 16px;
  }
  .nextPreviousButtons {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .checkbox {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  a:hover {
      background-color: #ddd;
      color: black;
  }

  .previous {
      background-color: #f1f1f1;
      color: black;
  }

  .next {
      background-color: #002147;
      color: white;
  }

  .round {
      border-radius: 15px;
  }
  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

  .x.axis path {
    display: none;
  }

  .line {
    fill: none;
    stroke: steelblue;
    stroke-width: 1.5px;
  }

  #chart {
    display: flex;
    justify-content: center;
    align-items: center;
  }
  </style>
  <title>Dollars For Docs</title>
</head>
<body>
<!-- <link rel="stylesheet" type="text/css" href="../graphs/styles.css"> -->
  <ul>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/pharmacies.html">ARCOS/Pharmacies</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/iwp.html">Injured Workers Pharmacy</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/ods.html">Overdoses in Providence</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/rhodes.html">Rhodes</a></li>
    <li><a style="font-family: auto" href="https://htried.github.io/opioid-journalism/51683a4d5705501cd25b927086d2ec088354fc55/html/stories/courtdata.html">Court Data</a></li>
  </ul>
  <h1> Dollars For Docs </h1>

  <h2> Basic Information </h2>
  <ul>
    <li>ProPublica is a nonprofit organization based in NYC that aims to produce investigative journalism in the public interest.</li>
    <li/>ProPublica's Dollars for Docs dataset is from the source data provided by the Centers of Medicare & Medicaid Services.
    <li/>The dataset contains all the payments made from August 1, 2013 to December 31, 2015.
    <li/>The Dollars for Docs dataset was $250 on the ProPublic website, so we obtained the each year's Open Payments Dataset from the CMS website and processed the data on our own.
    <li/>There are some slight changes in data collection between 2015 and 2016, so 2013-2015 datasets had the same format and 2016-2018 had a different one.
    <li/>Pharmaceutical and medical device companies are required by law to release details of their payments to doctors and U.S. teaching hospitals for a variety of categories
    <li>The Nature of Payments included:</li>
      <ul>
        <li><a style="font-family: auto" href="https://www.cms.gov/OpenPayments/About/Natures-of-Payment">See full list with definition and examples here.</a></li>
        <li>Consulting fee</li>
        <li>Food and beverage</li>
        <ul><li>A sales person from a drug manufacturer asks a physician if they can talk with them about a new drug. They meet over lunch, and the salesperson pays for the meal.</li></ul>
        <li/>Travel and lodging
        <li/>Gift
        <ul><li>Promotional items such as clocks or flash drives that have the companyâ€™s name printed on them.</li></ul>
        <li/>Entertainment
        <ul><li>Tickets to sporting events, concerts or theater shows.</li></ul>
        <li/>Education
        <ul><li>Companies that produce or sell drugs or devices for a particular medical condition may offer textbooks to physicians, free of charge, related to the latest treatments for that condition.</li></ul>
        <li/>Research
        <ul><li>Payment for different types of research activities, including enrolling patients into studies of new drugs or devices.</li></ul>
        <li/>Charitable contribution
        <ul><li>Any payment or transfer of value made to an organization with tax-exempt status under the Internal Revenue Code of 1986, but only if it is not more specifically described by one of the other nature or payment categories.</li></ul>
        <li/>Royalty or license
        <li/>Current or prospective ownership or investment interest
        <ul><li>Ownership or investment interests currently held by physicians and teaching hospitals, as well as ownership interests or investments that physicians and teaching hospitals have not yet exercised.</li></ul>
        <li/>Compensation for serving as faculty or as a speaker for an unaccredited and non-certified continuing education program
        <li/>Compensation for serving as faculty or as a speaker for an accredited or certified continuing education program
        <li/>Grant
        <li>Space rental or facility fees</li>
      </ul>
      <li/>Compiled a <b><a href="https://docs.google.com/spreadsheets/d/142WL0tSvX-Dp1AoHdeNecivOmi43ATPO-9PWxb_n1zQ/edit?usp=sharing">Master List</a></b>of RI doctors that were paid by Purdue and Rhodes from 2013-2018.
      <ul><li/>These doctors were filtered out by the transaction details.
        <li/>We filtered for opioid drugs that were listed in their transaction details.
        <ul><li>Got the complete list of drugs from this <a href="https://www.hopkinsmedicine.org/opioids/what-are-opioids.html">website</a></ul></li>
        <li/>For the 2016-2018 dataset, we also filtered additionally for Product and Therapeautic Categories that involved pain/pain management and opioid to get the most accurate picture.
        <li>Categories used were:</li>
        <ul>
          <li/>pain
          <li/>opioid analgesic
          <li/>opioid addiction
          <li/>maintenance treatment of opioid dependence
          <li/>opioid antagonistopioid induced constipation
          <li/>for the management of pain due to oral lesions
          <li/>pain management
          <li/>anesthesiology (pain management)
          <li/>pain management pump
          <li/>anesthesia and pain
          <li/>inflammation;pain
        </ul>
  </ul>
  <h1>Payments to Doctors</h1>
  <svg id="chart" width="1080" height="500"></svg>
<div class = "checkbox">
  Select filter:
  <select id="category"></select>

  <input type="checkbox" id="sort">
  Toggle sort
</div>
  <script>
  d3.csv("../graphs/data/master_dollars.csv").then(d => chart(d))

  function chart(csv) {

    var colors = ["4682b4", "FF8C00"]

  	var keys = csv.columns.slice(2);

    var year = [...new Set(csv.map(d => d.category))]
  	//var year   = ['National', 'RI']
  	var years = [...new Set(csv.map(d => d.year))]
    //var years = [...new Set(csv.map(d => d.year))]

  	var options = d3.select("#category").selectAll("option")
  		.data(year)
  	.enter().append("option")
  		.text(d => d)

  	var svg = d3.select("#chart"),
  		margin = {top: 50, left: 50, bottom: 15, right: 35},
  		width = +svg.attr("width") - margin.left - margin.right,
  		height = +svg.attr("height") - margin.top - margin.bottom;

  	var x = d3.scaleBand()
  		.range([margin.left, width - margin.right])
  		.padding(0.1)

  	var y = d3.scaleLinear()
  		.rangeRound([height - margin.bottom, margin.top])

  	var xAxis = svg.append("g")
  		.attr("transform", `translate(0,${height - margin.bottom})`)
  		.attr("class", "x-axis")

    // x-axis label
    svg.append("text")
      .attr("x", (width / 2))
      .attr("y", height + (margin.bottom))
      .style("font-size", "12px")
      .style("text-anchor", "middle")
      .text("Date");

  	var yAxis = svg.append("g")
  		.attr("transform", `translate(${margin.left},0)`)
  		.attr("class", "y-axis")

    // y-axis label
    svg.append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0)
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .style("font-size", "15px")
      .text("Payments ($)");

    // add legend
    var legend = svg.selectAll(".legend")
      .data(colors)
      .enter().append("g")
      .attr("class", "legend")
      .attr("transform", function(d, i) { return "translate(-50," + (i * 19 + 15) + ")"; });

    legend.append("rect")
      .attr("x", width - 18)
      .attr("width", 18)
      .attr("height", 18)
      .style("fill", function(d, i) {return colors.slice().reverse()[i];});

    legend.append("text")
      .attr("x", width + 3)
      .attr("y", 9)
      .attr("dy", ".35em")
      .style("text-anchor", "start")
      .text(function(d, i) {
        switch (i) {
          case 0: return "Rhodes Pharma";
          case 1: return "Purdue Pharma";
        }
      });

    // add title of graph
    svg.append("text")
          .attr("x", (width / 2))
          .attr("y", 0 + (margin.top/2))
          .attr("text-anchor", "middle")
          .style("font-size", "16px")
          .style("text-decoration", "underline")
          .text("Payments to Doctors");

  	var z = d3.scaleOrdinal()
  		.range(["steelblue", "darkorange", "lightblue"])
  		.domain(keys);

  	update(d3.select("#category").property("value"), 0)

  	function update(input, speed) {
      var dateParse = d3.timeFormat("%Y");
      var formatDecimalComma = d3.format(",.2f");
      var moneyParse = function(d) { return "$" + formatDecimalComma(d); };

  		var data = csv.filter(f => f.category == input)

      var dataset = ["Purdue Pharma", "Rhodes Pharma"].map(function(pharma) {
        return data.map(function(d) {
          var y0 = 0
          if (pharma == "Rhodes Pharma") {
            y0 = +d["Purdue Pharma"]
          }
          return {x: dateParse(d.year), y: +d[pharma], y0:y0};
        });
      });
      console.log(dataset)

  		data.forEach(function(d) {
        d.purdue = d["Purdue Pharma"]
        d.rhodes = d["Rhodes Pharma"]
  			d.total = d3.sum(keys, k => +d[k])
  			return d
  		})
      console.log(data)

  		y.domain([0, d3.max(data, d => d3.sum(keys, k => +d[k]))]).nice();

  		svg.selectAll(".y-axis").transition().duration(speed)
  			.call(d3.axisLeft(y).ticks(null, "s"))

  		data.sort(d3.select("#sort").property("checked")
  			? (a, b) => b.total - a.total
  			: (a, b) => years.indexOf(a.year) - years.indexOf(b.year))

  		x.domain(data.map(d => d.year));

      z.domain(keys)

  		svg.selectAll(".x-axis").transition().duration(speed)
  			.call(d3.axisBottom(x).tickSizeOuter(0))
      //   var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");



  		var group = svg.selectAll("g.layer")
  			.data(d3.stack().keys(keys)(data), d => d.key)

  		group.exit().remove()

  		group.enter().append("g")
  			.classed("layer", true)
  			.attr("fill", d => z(d.key));

  		var bars = svg.selectAll("g.layer").selectAll("rect")
  			.data(d => d, e => e.data.year);

  		bars.exit().remove()

  		bars.enter().append("rect")
  			.attr("width", x.bandwidth())
  			.merge(bars)
        .attr("x", d => x(d.data.year))
  			.attr("y", d => y(d[1]))
  			.attr("height", d => y(d[0]) - y(d[1]))
        .on("mouseover", function() { tooltip.style("display", null); })
        .on("mouseout", function() { tooltip.style("display", "none"); })
        .on("mousemove", function(d) {
          var xPosition = d3.mouse(this)[0] - 15;
          var yPosition = d3.mouse(this)[1] - 25;
          tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
          tooltip.select("text").text(moneyParse(d[1]-d[0]));
        });

  		var text = svg.selectAll(".text")
  			.data(data, d => d.year);

  		text.exit().remove()

  		text.enter().append("text")
  			.attr("class", "text")
  			.attr("text-anchor", "middle")
  			.merge(text)
  		  .transition().duration(speed)
  			.attr("x", d => x(d.year) + x.bandwidth() / 2)
  			.attr("y", d => y(d.total) - 5)
  			.text(d => moneyParse(d.total))

    	var select = d3.select("#category")
    		.on("change", function() {
    			update(this.value, 750)
    		})

      var checkbox = d3.select("#sort")
    		.on("click", function() {
    			update(select.property("value"), 750)
    		})
  	}

    // Prep the tooltip bits, initial display is hidden
    var tooltip = svg.append("g")
      .attr("class", "tooltip")
      .style("display", "none");

    tooltip.append("rect")
      .attr("width", 30)
      .attr("height", 20)
      .attr("fill", "white")
      .style("opacity", 0.5);

    tooltip.append("text")
      .attr("x", 15)
      .attr("dy", "1.2em")
      .style("text-anchor", "middle")
      .attr("font-size", "12px")
      .attr("font-weight", "bold");
  }
  </script>

  <p>The graph above compares the total amount of money Purdue and Rhodes have paid doctors nationally and filtered just for Rhode Island. You can also toggle sort each graph to see the years sorted in descending order based on the total amount paid by Purdue and Rhodes. For both graphs, there is an enormous spike in 2015, especially in Rhode Island. Purdue paid doctors a total of 3 times more from 2014 to 2015 and then dropped to less than 12 times the amount in 2016. Rhodes started paying doctors in Rhode Island starting 2016, while they started paying doctors in other states in 2015. Be aware that 2013 does not depict the entire calendar year of 2013, August-December, which only consists of 5 months from the calendar year.</p>
</body>
</html>
