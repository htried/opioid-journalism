<html>
<head>
<meta charset ="utf-8">
<script src="https://d3js.org/d3.v5.min.js"></script>
<style>

body {
	margin: auto;
	width: 650px;
	font: 12px arial;
}

</style>
</head>

<body>

<svg id="chart" width="750" height="500"></svg>

Select year:
<select id="category"></select>

<input type="checkbox" id="sort">
Toggle sort

<script>

d3.csv("data/master_dollars.csv").then(d => chart(d))

function chart(csv) {

  var colors = ["4682b4", "FF8C00"]

	var keys = csv.columns.slice(2);

  var year = [...new Set(csv.map(d => d.category))]
	//var year   = ['National', 'RI']
	var years = [...new Set(csv.map(d => d.year))]
  //var years = [...new Set(csv.map(d => d.year))]

	var options = d3.select("#category").selectAll("option")
		.data(year)
	.enter().append("option")
		.text(d => d)

	var svg = d3.select("#chart"),
		margin = {top: 50, left: 50, bottom: 15, right: 35},
		width = +svg.attr("width") - margin.left - margin.right,
		height = +svg.attr("height") - margin.top - margin.bottom;

	var x = d3.scaleBand()
		.range([margin.left, width - margin.right])
		.padding(0.1)

	var y = d3.scaleLinear()
		.rangeRound([height - margin.bottom, margin.top])

	var xAxis = svg.append("g")
		.attr("transform", `translate(0,${height - margin.bottom})`)
		.attr("class", "x-axis")

  // x-axis label
  svg.append("text")
    .attr("x", (width / 2))
    .attr("y", height + (margin.bottom))
    .style("font-size", "12px")
    .style("text-anchor", "middle")
    .text("Date");

	var yAxis = svg.append("g")
		.attr("transform", `translate(${margin.left},0)`)
		.attr("class", "y-axis")

  // y-axis label
  svg.append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", 0)
    .attr("x",0 - (height / 2))
    .attr("dy", "1em")
    .style("text-anchor", "middle")
    .style("font-size", "12px")
    .text("Payments ($)");

  // add legend
  var legend = svg.selectAll(".legend")
    .data(colors)
    .enter().append("g")
    .attr("class", "legend")
    .attr("transform", function(d, i) { return "translate(-50," + (i * 19 + 15) + ")"; });

  legend.append("rect")
    .attr("x", width - 18)
    .attr("width", 18)
    .attr("height", 18)
    .style("fill", function(d, i) {return colors.slice().reverse()[i];});

  legend.append("text")
    .attr("x", width + 3)
    .attr("y", 9)
    .attr("dy", ".35em")
    .style("text-anchor", "start")
    .text(function(d, i) {
      switch (i) {
        case 0: return "Rhodes Pharma";
        case 1: return "Purdue Pharma";
      }
    });

  // add title of graph
  svg.append("text")
        .attr("x", (width / 2))
        .attr("y", 0 + (margin.top/2))
        .attr("text-anchor", "middle")
        .style("font-size", "16px")
        .style("text-decoration", "underline")
        .text("Payments to Doctors");

	var z = d3.scaleOrdinal()
		.range(["steelblue", "darkorange", "lightblue"])
		.domain(keys);

	update(d3.select("#category").property("value"), 0)

	function update(input, speed) {
    var dateParse = d3.timeFormat("%Y");
    var formatDecimalComma = d3.format(",.2f");
    var moneyParse = function(d) { return "$" + formatDecimalComma(d); };

		var data = csv.filter(f => f.category == input)

    var dataset = ["Purdue Pharma", "Rhodes Pharma"].map(function(pharma) {
      return data.map(function(d) {
        var y0 = 0
        if (pharma == "Rhodes Pharma") {
          y0 = +d["Purdue Pharma"]
        }
        return {x: dateParse(d.year), y: +d[pharma], y0:y0};
      });
    });
    console.log(dataset)

		data.forEach(function(d) {
      d.purdue = d["Purdue Pharma"]
      d.rhodes = d["Rhodes Pharma"]
			d.total = d3.sum(keys, k => +d[k])
			return d
		})
    console.log(data)

		y.domain([0, d3.max(data, d => d3.sum(keys, k => +d[k]))]).nice();

		svg.selectAll(".y-axis").transition().duration(speed)
			.call(d3.axisLeft(y).ticks(null, "s"))

		data.sort(d3.select("#sort").property("checked")
			? (a, b) => b.total - a.total
			: (a, b) => years.indexOf(a.year) - years.indexOf(b.year))

		x.domain(data.map(d => d.year));

    z.domain(keys)

		svg.selectAll(".x-axis").transition().duration(speed)
			.call(d3.axisBottom(x).tickSizeOuter(0))
    //   var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");



		var group = svg.selectAll("g.layer")
			.data(d3.stack().keys(keys)(data), d => d.key)

		group.exit().remove()

		group.enter().append("g")
			.classed("layer", true)
			.attr("fill", d => z(d.key));

		var bars = svg.selectAll("g.layer").selectAll("rect")
			.data(d => d, e => e.data.year);

		bars.exit().remove()

		bars.enter().append("rect")
			.attr("width", x.bandwidth())
			.merge(bars)
      .attr("x", d => x(d.data.year))
			.attr("y", d => y(d[1]))
			.attr("height", d => y(d[0]) - y(d[1]))
      .on("mouseover", function() { tooltip.style("display", null); })
      .on("mouseout", function() { tooltip.style("display", "none"); })
      .on("mousemove", function(d) {
        var xPosition = d3.mouse(this)[0] - 15;
        var yPosition = d3.mouse(this)[1] - 25;
        tooltip.attr("transform", "translate(" + xPosition + "," + yPosition + ")");
        tooltip.select("text").text(moneyParse(d[1]-d[0]));
      });

		var text = svg.selectAll(".text")
			.data(data, d => d.year);

		text.exit().remove()

		text.enter().append("text")
			.attr("class", "text")
			.attr("text-anchor", "middle")
			.merge(text)
		  .transition().duration(speed)
			.attr("x", d => x(d.year) + x.bandwidth() / 2)
			.attr("y", d => y(d.total) - 5)
			.text(d => moneyParse(d.total))

  	var select = d3.select("#category")
  		.on("change", function() {
  			update(this.value, 750)
  		})

    var checkbox = d3.select("#sort")
  		.on("click", function() {
  			update(select.property("value"), 750)
  		})
	}

  // Prep the tooltip bits, initial display is hidden
  var tooltip = svg.append("g")
    .attr("class", "tooltip")
    .style("display", "none");

  tooltip.append("rect")
    .attr("width", 30)
    .attr("height", 20)
    .attr("fill", "white")
    .style("opacity", 0.5);

  tooltip.append("text")
    .attr("x", 15)
    .attr("dy", "1.2em")
    .style("text-anchor", "middle")
    .attr("font-size", "12px")
    .attr("font-weight", "bold");
}


</script>

</body>
</html>
